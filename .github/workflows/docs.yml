name: Deploy Documentation to GitHub Pages

on:
  push:
    branches: [master, main]
    paths: ['dot_docs/**', '.github/workflows/docs.yml']
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build documentation site
        run: |
          # Create site structure
          mkdir -p _site
          
          # Copy documentation files from dot_docs
          cp -r dot_docs/* _site/
          
          # Install and use a proper markdown converter
          pip install markdown
          
          # Function to convert markdown to HTML with proper styling
          convert_md_to_html() {
              local md_file="$1"
              local html_file="$2"
              local nav_link="$3"
              
              title=$(head -n1 "$md_file" | sed 's/^# //')
              
              cat > "$html_file" << HTML_HEADER
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>$title - Dotfiles Documentation</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      line-height: 1.6;
                      max-width: 800px;
                      margin: 0 auto;
                      padding: 2rem;
                      color: #333;
                  }
                  h1, h2, h3, h4, h5, h6 { color: #2c3e50; margin-top: 2rem; }
                  h1 { border-bottom: 2px solid #3498db; padding-bottom: 0.5rem; }
                  h2 { border-bottom: 1px solid #ecf0f1; padding-bottom: 0.3rem; }
                  code { 
                      background: #f8f9fa; 
                      padding: 0.2em 0.4em; 
                      border-radius: 3px; 
                      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
                      font-size: 0.9em;
                  }
                  pre { 
                      background: #f8f9fa; 
                      padding: 1rem; 
                      border-radius: 8px; 
                      overflow-x: auto;
                      border: 1px solid #e9ecef;
                  }
                  pre code { background: none; padding: 0; }
                  table { 
                      border-collapse: collapse; 
                      width: 100%; 
                      margin: 1rem 0;
                      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                  }
                  th, td { 
                      border: 1px solid #ddd; 
                      padding: 0.75rem; 
                      text-align: left; 
                  }
                  th { 
                      background: #3498db; 
                      color: white;
                      font-weight: 600;
                  }
                  tr:nth-child(even) { background: #f8f9fa; }
                  a { color: #3498db; text-decoration: none; }
                  a:hover { text-decoration: underline; }
                  .nav { 
                      margin-bottom: 2rem; 
                      padding: 1rem; 
                      background: #f8f9fa;
                      border-radius: 8px;
                      border-left: 4px solid #3498db;
                  }
                  ul, ol { padding-left: 2rem; }
                  li { margin: 0.5rem 0; }
                  blockquote {
                      border-left: 4px solid #3498db;
                      background: #f8f9fa;
                      margin: 1rem 0;
                      padding: 1rem 1rem 1rem 2rem;
                      border-radius: 0 8px 8px 0;
                  }
              </style>
          </head>
          <body>
              <nav class="nav">
                  <a href="$nav_link">‚Üê Back to Documentation Index</a>
              </nav>
              <div class="content">
          HTML_HEADER
          
              python3 -c "
          import markdown
          import sys
          
          with open('$md_file', 'r', encoding='utf-8') as f:
              content = f.read()
          
          md = markdown.Markdown(extensions=['codehilite', 'tables', 'toc', 'fenced_code'])
          html_content = md.convert(content)
          
          print(html_content)
          " >> "$html_file"
              
              echo '</div></body></html>' >> "$html_file"
          }
          
          # Convert README.md to index.html
          convert_md_to_html "_site/README.md" "_site/index.html" "index.html"
          
          # Convert all other markdown files, maintaining directory structure
          find _site -name "*.md" -not -name "README.md" | while read md_file; do
              # Calculate relative path for HTML file
              html_file="${md_file%.md}.html"
              
              # Calculate navigation link (relative to subdirectory)
              relative_path=$(dirname "$md_file" | sed 's|_site||' | sed 's|^/||')
              if [ -n "$relative_path" ]; then
                  nav_link="../index.html"
              else
                  nav_link="index.html"
              fi
              
              convert_md_to_html "$md_file" "$html_file" "$nav_link"
          done

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4