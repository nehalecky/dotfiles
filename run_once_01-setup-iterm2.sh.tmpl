#!/usr/bin/env bash
#
# One-time iTerm2 setup for chezmoi
# This script runs once to configure iTerm2 to use our managed JSON profiles

set -euo pipefail

echo "üöÄ Setting up iTerm2 configuration management..."

# Create the DynamicProfiles directory in the standard location
ITERM_SUPPORT_DIR="$HOME/Library/Application Support/iTerm2"
DYNAMIC_PROFILES_DIR="$ITERM_SUPPORT_DIR/DynamicProfiles"

if [ ! -d "$DYNAMIC_PROFILES_DIR" ]; then
    echo "üìÅ Creating DynamicProfiles directory..."
    mkdir -p "$DYNAMIC_PROFILES_DIR"
fi

# Create a symlink from our config to iTerm's expected location
# This allows chezmoi to manage the files while iTerm2 finds them automatically
CONFIG_SOURCE="$HOME/.config/iterm2/DynamicProfiles"
if [ ! -L "$DYNAMIC_PROFILES_DIR" ] && [ -d "$CONFIG_SOURCE" ]; then
    echo "üîó Linking managed profiles to iTerm2..."
    # Backup existing directory if it exists and isn't empty
    if [ -d "$DYNAMIC_PROFILES_DIR" ] && [ "$(ls -A "$DYNAMIC_PROFILES_DIR")" ]; then
        echo "üì¶ Backing up existing profiles..."
        mv "$DYNAMIC_PROFILES_DIR" "${DYNAMIC_PROFILES_DIR}.backup.$(date +%Y%m%d_%H%M%S)"
    fi
    # Remove empty directory if it exists
    [ -d "$DYNAMIC_PROFILES_DIR" ] && rmdir "$DYNAMIC_PROFILES_DIR"
    # Create symlink
    ln -sf "$CONFIG_SOURCE" "$DYNAMIC_PROFILES_DIR"
    echo "‚úÖ Symlink created: $DYNAMIC_PROFILES_DIR -> $CONFIG_SOURCE"
fi

# Set iTerm2 to load preferences from custom folder (optional, for full prefs sync)
# This is for the main preferences plist, not just profiles
if command -v defaults >/dev/null 2>&1; then
    echo "‚öôÔ∏è  Configuring iTerm2 preferences location..."
    defaults write com.googlecode.iterm2 LoadPrefsFromCustomFolder -bool true
    defaults write com.googlecode.iterm2 PrefsCustomFolder -string "$HOME/.config/iterm2/preferences"
    defaults write com.googlecode.iterm2 NoSyncNeverRemindPrefsChangesLostForFile_selection -bool true
fi

echo "‚ú® iTerm2 setup complete!"
echo ""
echo "üìù Next steps:"
echo "1. If you haven't already, export your current profile:"
echo "   - Open iTerm2 ‚Üí Preferences ‚Üí Profiles"
echo "   - Select your profile ‚Üí Other Actions ‚Üí Save Profile as JSON"
echo "   - Save to: ~/.config/iterm2/DynamicProfiles/default.json"
echo ""
echo "2. Add to chezmoi:"
echo "   chezmoi add ~/.config/iterm2/DynamicProfiles/"
echo ""
echo "3. iTerm2 will now automatically:"
echo "   - Load profiles from ~/.config/iterm2/DynamicProfiles/"
echo "   - Save changes back to the same JSON files"
echo "   - Reload when files change (great for chezmoi apply!)"