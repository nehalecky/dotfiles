#!/bin/bash
# Refresh any workspace type without relaunching
# Usage: workspace-refresh

echo "🔄 Refreshing workspace..."

# Detect workspace type from current tab title
CURRENT_TAB=$(wezterm cli list | grep "TAB" | grep "true" | head -1)
TAB_TITLE=$(echo "$CURRENT_TAB" | awk '{for(i=4;i<=NF;i++) printf "%s ", $i; print ""}' | sed 's/[[:space:]]*$//')

if [[ "$TAB_TITLE" == *"Home Command Center"* ]]; then
    echo "🏠 Detected Home Command Center workspace"
    
    # Refresh weather pane if it exists
    WEATHER_PANE_ID=$(wezterm cli list | grep "PANE" | grep "🌍" | awk '{print $2}' | head -1)
    if [[ -n "$WEATHER_PANE_ID" ]]; then
        echo "  🌤️ Refreshing weather data..."
        wezterm cli send-text --pane-id "$WEATHER_PANE_ID" "clear" && wezterm cli send-text --pane-id "$WEATHER_PANE_ID" ""
    fi
    
elif [[ "$TAB_TITLE" == *"Dev:"* ]]; then
    echo "💻 Detected Development workspace"
    
    # Refresh git pane if lazygit is running
    GIT_PANE_ID=$(wezterm cli list | grep "PANE" | grep -E "(lazygit|git)" | awk '{print $2}' | head -1)
    if [[ -n "$GIT_PANE_ID" ]]; then
        echo "  📦 Refreshing git status..."
        wezterm cli send-text --pane-id "$GIT_PANE_ID" "R"  # 'R' refreshes in lazygit
    fi
    
    # Refresh any btop/monitor panes
    MONITOR_PANE_ID=$(wezterm cli list | grep "PANE" | grep -E "(btop|monitor)" | awk '{print $2}' | head -1)
    if [[ -n "$MONITOR_PANE_ID" ]]; then
        echo "  📊 Refreshing system monitor..."
        wezterm cli send-text --pane-id "$MONITOR_PANE_ID" "q"
        sleep 0.5
        wezterm cli send-text --pane-id "$MONITOR_PANE_ID" "btop"
    fi
    
else
    echo "❓ Unknown workspace type, doing generic refresh..."
fi

# Universal refreshes for any workspace type
echo "  🔄 Performing universal refreshes..."

# Refresh taskwarrior-tui if it's running anywhere
TASK_PANE_ID=$(wezterm cli list | grep "PANE" | grep -E "(taskwarrior|Task Management)" | awk '{print $2}' | head -1)
if [[ -n "$TASK_PANE_ID" ]]; then
    echo "  ✅ Refreshing task data..."
    wezterm cli send-text --pane-id "$TASK_PANE_ID" "r"  # 'r' refreshes in taskwarrior-tui
fi

# Refresh any yazi file manager panes
YAZI_PANE_ID=$(wezterm cli list | grep "PANE" | grep "yazi" | awk '{print $2}' | head -1)
if [[ -n "$YAZI_PANE_ID" ]]; then
    echo "  📁 Refreshing file manager..."
    wezterm cli send-text --pane-id "$YAZI_PANE_ID" "R"  # 'R' refreshes in yazi
fi

echo "✅ Workspace refresh complete!"