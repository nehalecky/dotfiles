#!/bin/bash
# Refresh any workspace type without relaunching
# Usage: workspace-refresh

echo "üîÑ Refreshing workspace..."

# Detect workspace type from current window title
# Note: We'll look for Home Command Center or Dev workspace patterns
WORKSPACE_TYPE="unknown"
if wezterm cli list | grep -q "Home Command Center"; then
    WORKSPACE_TYPE="home"
elif wezterm cli list | grep -q "Dev:"; then
    WORKSPACE_TYPE="dev"
fi

if [[ "$WORKSPACE_TYPE" == "home" ]]; then
    echo "üè† Detected Home Command Center workspace"
    
    # Refresh weather pane if it exists (look for weather-related text)
    WEATHER_PANE_ID=$(wezterm cli list | grep "üåç\|Weather" | awk '{print $3}' | head -1)
    if [[ -n "$WEATHER_PANE_ID" ]]; then
        echo "  üå§Ô∏è Refreshing weather data..."
        wezterm cli send-text --pane-id "$WEATHER_PANE_ID" $'\003'  # Ctrl+C to interrupt
        sleep 1
        wezterm cli send-text --pane-id "$WEATHER_PANE_ID" "clear\r"
    fi
    
elif [[ "$WORKSPACE_TYPE" == "dev" ]]; then
    echo "üíª Detected Development workspace"
    
    # Refresh git pane if lazygit is running
    GIT_PANE_ID=$(wezterm cli list | grep -E "lazygit|git" | awk '{print $3}' | head -1)
    if [[ -n "$GIT_PANE_ID" ]]; then
        echo "  üì¶ Refreshing git status..."
        wezterm cli send-text --pane-id "$GIT_PANE_ID" "R"  # 'R' refreshes in lazygit
    fi
    
    # Refresh any btop/monitor panes  
    MONITOR_PANE_ID=$(wezterm cli list | grep -E "btop|monitor" | awk '{print $3}' | head -1)
    if [[ -n "$MONITOR_PANE_ID" ]]; then
        echo "  üìä Refreshing system monitor..."
        wezterm cli send-text --pane-id "$MONITOR_PANE_ID" "q\r"
        sleep 0.5
        wezterm cli send-text --pane-id "$MONITOR_PANE_ID" "btop\r"
    fi
    
else
    echo "‚ùì Unknown workspace type, doing generic refresh..."
fi

# Universal refreshes for any workspace type
echo "  üîÑ Performing universal refreshes..."

# Refresh taskwarrior-tui if it's running anywhere
TASK_PANE_ID=$(wezterm cli list | grep "taskwarrior" | awk '{print $3}' | head -1)
if [[ -n "$TASK_PANE_ID" ]]; then
    echo "  ‚úÖ Refreshing task data..."
    wezterm cli send-text --pane-id "$TASK_PANE_ID" "r"  # 'r' refreshes in taskwarrior-tui
fi

# Refresh any yazi file manager panes
YAZI_PANE_ID=$(wezterm cli list | grep "Yazi:" | awk '{print $3}' | head -1)
if [[ -n "$YAZI_PANE_ID" ]]; then
    echo "  üìÅ Refreshing file manager..."
    wezterm cli send-text --pane-id "$YAZI_PANE_ID" "R"  # 'R' refreshes in yazi
fi

echo "‚úÖ Workspace refresh complete!"