#!/bin/bash
# Home Command Center - Daily operations workspace
# A persistent workspace for dotfiles management, AI assistance, and task tracking

set -euo pipefail

echo "🏠 Launching Home Command Center workspace"
echo "📁 Working directory: $HOME"

# Start in HOME directory
cd "$HOME"

# Create new WezTerm window (fullscreen via manual Cmd+Enter if desired)
WINDOW_ID=$(wezterm cli spawn --new-window --cwd "$HOME" -- zsh)

# Top weather strip - 3 lines (8% height - just enough for 3 text lines)
WEATHER_PANE=$(wezterm cli split-pane --pane-id "$WINDOW_ID" --top --percent 8 -- zsh -c "
while true; do
    # Get current location using CoreLocationCLI (more accurate than IP)
    if command -v CoreLocationCLI >/dev/null 2>&1; then
        COORDS=\$(CoreLocationCLI -format '%latitude,%longitude' 2>/dev/null | tr ' ' ',')
        if [[ -n \"\$COORDS\" && \"\$COORDS\" != \",\" ]]; then
            CURRENT_LOC=\$(curl -s \"wttr.in/\$COORDS?format=%l\" | tr -d '\n' | sed 's/^[0-9.-]*,[0-9.-]*$/Precise Location/')
            [[ \"\$CURRENT_LOC\" =~ ^-?[0-9] ]] && CURRENT_LOC=\"Precise Location\"
        else
            CURRENT_LOC=\$(curl -s 'wttr.in/?format=%l' | tr -d '\n')
        fi
    else
        CURRENT_LOC=\$(curl -s 'wttr.in/?format=%l' | tr -d '\n')
    fi
    
    # Line 1: Title with dynamic location
    echo \"🌍 Current: \$CURRENT_LOC | Favorites: La Lucila, Reno, Futaleufú\"
    
    # Line 2: Current weather for all favorite locations
    echo -n '🏠 '; curl -s 'wttr.in/La_Lucila,Buenos_Aires?format=%t+%h+%w' | tr -d '\n'
    echo -n '  🎰 '; curl -s 'wttr.in/Reno,NV?format=%t+%h+%w' | tr -d '\n'  
    echo -n '  🏔️ '; curl -s 'wttr.in/Futaleufu,Chile?format=%t+%h+%w'
    
    # Line 3: 24-hour forecast for current detected location
    echo -n '⏰ Next 24hrs: '
    if command -v CoreLocationCLI >/dev/null 2>&1 && [[ -n \"\$COORDS\" && \"\$COORDS\" != \",\" ]]; then
        curl -s \"wttr.in/\$COORDS?format=Morning+%t+|+Noon+%t+|+Evening+%t+|+Night+%t+|+Tomorrow+AM+%t\"
    else
        curl -s 'wttr.in/?format=Morning+%t+|+Noon+%t+|+Evening+%t+|+Night+%t+|+Tomorrow+AM+%t'
    fi
    
    sleep 300  # Update every 5 minutes
done
")

# Upper right: File manager (yazi) - 50% width of remaining space
FILE_PANE=$(wezterm cli split-pane --pane-id "$WINDOW_ID" --right --percent 50 -- yazi "$HOME")

# Lower left: Claude Code - 50% height of left side, auto-launch
CLAUDE_PANE=$(wezterm cli split-pane --pane-id "$WINDOW_ID" --bottom --percent 50 -- zsh -c "
echo '🤖 Launching Claude Code...'
sleep 1
claude
")

# Lower right: Task dashboard - 50% height of right side
# Launch taskwarrior-tui if available, otherwise show task hints
if command -v taskwarrior-tui >/dev/null 2>&1; then
    TASK_PANE=$(wezterm cli split-pane --pane-id "$FILE_PANE" --bottom --percent 50 -- taskwarrior-tui)
else
    TASK_PANE=$(wezterm cli split-pane --pane-id "$FILE_PANE" --bottom --percent 50 -- zsh -c "
    echo '📋 Task Management Center'
    echo '────────────────────────'
    echo ''
    echo 'Quick Commands:'
    echo '  gh dash          - GitHub dashboard for issues/PRs'
    echo '  chezmoi status   - Check dotfile changes'
    echo '  chezmoi diff     - Review pending changes'
    echo '  brew outdated    - Check for updates'
    echo ''
    echo 'Workspace Shortcuts (Ctrl+a):'
    echo '  W = Launch project workspace'
    echo '  h = Return to home workspace'
    echo ''
    if command -v task >/dev/null 2>&1; then
        echo 'Taskwarrior detected! Commands:'
        echo '  task list        - Show all tasks'
        echo '  task add <desc>  - Add new task'
        echo '  taskwarrior-tui  - Interactive task manager'
        echo ''
        task list 2>/dev/null || true
    fi
    exec zsh
    ")
fi

# Set window title
wezterm cli set-tab-title --pane-id "$WINDOW_ID" "🏠 Home Command Center"

echo "✅ Home Command Center ready!"
echo ""
echo "Layout:"
echo "┌─────────────────┬─────────────────┐"
echo "│ Terminal (zsh)  │ Files (yazi)    │"
echo "│ HOME directory  │ File browser    │"
echo "├─────────────────┼─────────────────┤"
echo "│ Claude Code     │ Tasks/Status    │"
echo "│ AI assistance   │ Management      │"
echo "└─────────────────┴─────────────────┘"
echo ""
echo "💡 Tips:"
echo "  • Terminal starts in HOME directory"
echo "  • Use 'cd ~/.local/share/chezmoi' for dotfiles source"
echo "  • Use 'chezmoi edit <file>' to modify configs"
echo "  • Run 'workspace-dev <project>' to launch project workspace"
echo "  • This workspace is for system management, not project development"